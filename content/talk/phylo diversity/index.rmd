---
---
---

------------------------------------------------------------------------

title: "Diversidad filogentica y rPD"

format: asciidoc

editor: visual

------------------------------------------------------------------------

## Diversidad filogentica y rPD

La diversidad filogenética es calculada como la suma de las longitudes de rama de las especies que co-ocurren en un ensamblaje regional. Los residual obtenidos entre PD y Riqueza es un proxi para identificar eventos evolutivos importantes (especiación, extinción o dispersión) y como estos han contribuido a los ensamblajes locales.
```{r klippy,message = FALSE,echo=FALSE}
klippy::klippy()

```


```{r,message = FALSE}


library(data.table)
library(terra)
library(letsR)
library(caper)
library(ape)
library(sf)
library(dplyr)
library(stringr)
library(picante)
library(ggplot2)
library(patchwork)
library(ggplot2)
library(viridis)
library(classInt)
library(ggplot2)
library(raster)

```

Para este ejercicio vamos a cargar el R data que contiene la PAM y la filogenia que incluye las especies de mamiferos de sur América. (Ya saben cómo construirla)\

Por ahora es importante saber que tenemos los mapas de distribucion de carnivora en Sur America.

```{r, message = FALSE}

load("Datacarn.RData")
pam_mamm$Richness_Raster<- terra::rast('richcarn.tif')

```

Para explorar la PAM podemos plotear el raster de riqueza que contiene

```{r,fig.width = 3, fig.height = 4}


SR<-as.data.frame(pam_mamm$Richness_Raster,xy=TRUE,na.rm=TRUE)%>% 
filter (lyr.1!=0)%>%rename( "Riqueza"="lyr.1")


mapSR<-ggplot()+geom_tile(data = SR , aes(x = x, y = y, fill = Riqueza))+
scale_fill_viridis_c(limits = c(0, 25),option = "H")+theme_void()+
theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())


mapSR

```

Para el cálculo de PD necesitamos una matriz de presencia ausencia.

```{r}

pa<-pam_mamm$Presence_and_Absence_Matrix
pas<-pa[,c(-1,-2)]

```

calculamos PD

```{r, message = FALSE,warning=FALSE}

#calculamos pd
pdmaam<-pd(pas,phymmam, include.root=FALSE)

#adicionamos una columna a la matriz PA
Pd_table<-cbind(pam_mamm$Presence_and_Absence_Matrix,pdmaam)

#ordenamos la tabla
sort<-Pd_table%>% na.omit()%>% as.data.frame() %>% arrange(desc(SR))

#realizamos una regresion LOESS
model<- loess(PD ~ SR,data=sort)

```

Y ploteamos esta relación ¿Qué observas?

```{r,fig.width = 6, fig.height = 6}

model<- loess(PD ~ SR,data=sort)
plot(sort$SR,sort$PD, xlab="Riqueza",ylab="PD",pch=19)


pred<-predict(model)
lines(pred, x=sort$SR, col="red")
names(sort)[c(1,2)]<-c("x","y")  

rPD <- residuals(model)

finaldata<-cbind(sort,rPD)


```

Y si vemos esto en mapas.

```{r,fig.width = 10, fig.height = 4}

# Mapa PD #

brks_ht<- classIntervals(finaldata$PD, n=35,style = "fisher")
breakss<-brks_ht$brk

mapPD<-ggplot()+geom_tile(data = finaldata , aes(x = x, y = y, fill = PD))+scale_fill_viridis_b(breaks = breakss,option = "H",labels=c("1.6", rep("",34),"503"))+  theme_void()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

# Mapa rpD #
#creo mi paleta de colores.

rPD_plott<-finaldata$rPD[-which(is.na(finaldata$rPD))]

positive<-finaldata$rPD[which(finaldata$rPD>=0)]
negative<-finaldata$rPD[which(finaldata$rPD<0)]
brks_htpos <- classIntervals( positive, n=15,style = "equal")
breaksp<-c(brks_htpos$brks)

brks_htneg <- classIntervals( negative, n=15,style = "equal")
breaksn<-c(brks_htneg$brks)
breakstotal<-c(breaksn,breaksp)

colp<-viridis_pal(alpha = 1,option="rocket",direction = -1)(36)
coln<-viridis_pal(alpha = 1,option="mako",direction = 1)(16)
cols<-c(coln,colp[1:15])

maprPD<-ggplot()+
  geom_tile(data = finaldata , aes(x = x, y = y, fill =rPD))+
  scale_fill_gradientn(colours = cols,values = scales::rescale(breakstotal))+
      theme_void()+theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank())

mapSR + mapPD + maprPD

```

¿Qué significan los residuales positivos ?¿Y los negativos?

Los residuales positivos muestran una mayor diversidad filogenetica de lo esperado por la riqueza. Pueden ser lugares dónde se presentó una baja diversificaccion insitu pero se dieron muchos eventos de dispersión.

Por otro lado los residuales regativos indican coexistencia de linajes recientemente derivados o estrechamente relacionados.

y si queremos ver la riqueza y la diversidad filogenetica al mismo tiempo???

Primero necesitamos una función que yo tome desde el git de Stuart Brown https://github.com/scbrown86 que es una adaptacion del programa bivariate. 

```{r, output=FALSE}

source("functionbi.R")

```

creamos nuestro raster Bivariado

```{r}

#creamos un raster con las extensiones de nuestra PAM

xmn =-8134048
xmx =-3469127
ymn = -6462783
ymx = 1536355
resol = 110000
ras <- raster(xmn = xmn, xmx = xmx, ymn = ymn, ymx = ymx, crs ="ESRI:54009")

res(ras) <- 111000
values(ras) <- 1 

#y creamos nuestros raster de rPD PD y SR

matri<-finaldata[,1:2]
ras_rpd<-rasterize(matri,ras,values=finaldata$rPD)
ras_PD<-rasterize(matri,ras,finaldata$PD)
ras_SR<-rasterize(matri,ras,finaldata$SR)
nBreaks <- 10

```
NOTA: creamos raster para que "funcionara en nuestas funciones"

en caso de que quieran usar terra!: 
ras_rpd<-terra::rasterize(as.matrix(matri),y=pam_mamm$Richness_Raster,values=finaldata$rPD)


```{r,warning=FALSE,message=FALSE}
col.matrixQ <- colmat(nbreaks = nBreaks, breakstyle = "quantile",
                      xlab = "Richness", ylab = "rPD", 
                      bottomright = "#F7900A", upperright = "#993A65",
                      bottomleft = "#44B360", upperleft = "#3A88B5",
                      saveLeg = FALSE, plotLeg = TRUE)

# Creamos el raster bivariado
bivmapQ <- bivariate.map(rasterx = ras_SR, rastery = ras_rpd,
                         export.colour.matrix = FALSE,
                         colourmatrix = col.matrixQ)

```

```{r,fig.width = 7, fig.height = 10,warning = FALSE}


# creamos data frames para plotear con ggPlot

bivMapDFQ <- setDT(as.data.frame(bivmapQ, xy = TRUE))
colnames(bivMapDFQ)[3] <- "BivValue"
bivMapDFQ <- melt(bivMapDFQ, id.vars = c("x", "y"),
                  measure.vars = "BivValue",
                  value.name = "bivVal",
                  variable.name = "Variable")


map_bi<- ggplot(bivMapDFQ, aes(x = x, y = y)) +
  geom_raster(aes(fill = bivVal)) +
  scale_fill_gradientn(colours = col.matrixQ, na.value = "transparent") + 
 theme_void() +

   theme(legend.position = "none",
        plot.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
       axis.ticks.y=element_blank())

fig <- map_bi  +   inset_element(BivLegend + theme(plot.background = element_rect(fill = "white", colour = NA)), 0.8, 0.8, 1, 1,  align_to = "plot")


mapSR + mapPD + maprPD + fig



```
